# 寻找最大数



## 0.概述

本程序用ARM汇编语言编写，功能是遍历一个包含6个8字节整数的数组，找到其中的最大值，并使用`printf`函数将其打印出来。程序展示了ARM汇编中的内存操作、循环控制、条件判断以及函数调用等基本操作。

------

## 1.代码结构

### 1.1数据段 (.data)

数据段定义了程序中使用的全局变量和常量。

```
.section .data

# 2的3次方，也就是8字节对齐
.align 3

# quad 是8字节大小的变量
my_data:
    .quad 1    
    .quad 2
    .quad 3
    .quad 4
    .quad 10
    .quad 12
my_data_count:
    .quad 6

.align 3
print_data:
    .string "big data : %d\n"
```

- **`my_data`**: 一个包含6个8字节整数的数组，初始值为`[1, 2, 3, 4, 10, 12]`。
- **`my_data_count`**: 数组的长度，值为`6`。
- **`print_data`**: 格式化字符串，用于打印最大值。

------

### 1.2代码段 (.text)

代码段包含了程序的主要逻辑。

```
.section .text

.globl main

main:
    # 保存帧指针和返回地址
    stp x29, x30, [sp, -16]!

    ldr x0, =my_data
    ldr x1, my_data_count
    # （x0 + (5 x 8)） 指向my_data中最后一个数据，每个数据8字节
    add x4, x0, #40

    # xzr 寄存器的值始终为零，初始化 x3 为后续循环准备
    mov x3, xzr
1:
    # 拿 x0 + 8 的值给 x2，并且将 x0 的值增加 8
    ldr x2, [x0], #8           
    cmp x2, x3      
    # x3 取最大值            
    csel x3, x2, x3, hi        

    cmp x0, x4           
    # ls 是小于等于，如果是，往后跳到 1 标签
    b.ls 1b                    

    ldr x0, =print_data         

    # 给printf 传递两个参数, x0, x1；
    mov x1, x3              
    # 调用 printf函数
    bl printf               
    # 从栈中恢复帧指针和返回地址，并返回到调用者，在函数开始的时候保存的
    ldp x29, x30, [sp], #16    
    ret                       
```

------

## 2.代码详解

### 2.1初始化与准备

1. **保存帧指针和返回地址**:

   assembly

   复制

   ```
   stp x29, x30, [sp, -16]!
   ```

   - 将帧指针 (`x29`) 和返回地址 (`x30`) 保存到栈中，以便在函数结束时恢复。

2. **加载数组地址和长度**:

   assembly

   复制

   ```
   ldr x0, =my_data
   ldr x1, my_data_count
   ```

   - `x0` 存储数组的起始地址。
   - `x1` 存储数组的长度。

3. **计算数组末尾地址**:

   assembly

   复制

   ```
   add x4, x0, #40
   ```

   - 数组有6个元素，每个元素占8字节，因此末尾地址为 `x0 + 40`。

4. **初始化最大值寄存器**:

   assembly

   复制

   ```
   mov x3, xzr
   ```

   - `x3` 用于存储最大值，初始化为0。

------

### 2.2循环遍历数组

1. **加载当前元素**:

   assembly

   复制

   ```
   ldr x2, [x0], #8
   ```

   - 从 `x0` 指向的地址加载一个8字节的值到 `x2`，并将 `x0` 增加8（指向下一个元素）。

2. **比较当前元素与最大值**:

   assembly

   复制

   ```
   cmp x2, x3
   csel x3, x2, x3, hi
   ```

   - 如果 `x2` 大于 `x3`，则将 `x3` 更新为 `x2`。

3. **检查是否到达数组末尾**:

   assembly

   复制

   ```
   cmp x0, x4
   b.ls 1b
   ```

   - 如果 `x0` 小于等于 `x4`（未到达末尾），则跳回标签 `1`，继续循环。

------

### 2.3打印最大值

1. **加载格式化字符串地址**:

   assembly

   复制

   ```
   ldr x0, =print_data
   ```

   - `x0` 存储格式化字符串的地址。

2. **传递最大值参数**:

   assembly

   复制

   ```
   mov x1, x3
   ```

   - `x1` 存储最大值，作为 `printf` 的第二个参数。

3. **调用 `printf` 函数**:

   assembly

   复制

   ```
   bl printf
   ```

   - 调用 `printf` 函数打印最大值。

------

### 2.4恢复与返回

1. **恢复帧指针和返回地址**:

   assembly

   复制

   ```
   ldp x29, x30, [sp], #16
   ```

   - 从栈中恢复帧指针和返回地址。

2. **返回调用者**:

   assembly

   复制

   ```
   ret
   ```

   - 返回到调用者，结束程序。